<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual sort</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Firebase Initialization (should run before your custom scripts) -->
    <script src="firebase-init.js"></script>
    <link rel="stylesheet" href="style_table.css">
</head>
<body>
        <div id="mainContentContainer">
        <h2 id="pageTitleHeader">Loading user data...</h2> <!-- Placeholder title -->
        <div class="table" id="table">
            <!-- Table generated by JS -->
        </div>
    </div>
    <br>

    <!-- Virtual Profile List -->
    <fieldset>
        <legend id="virtualProfileListLegend">Virtual profile list</legend> <!-- Added ID -->
        <div id="virtualListContainer" class="select-list">
             <!-- Buttons generated by JS -->
        </div>
    </fieldset>
    <br>

    <!-- Action Buttons -->
    <button class="button2" id="addLineButton" onclick="add_lignes()">Add line
        <span class="tooltip" id="addLineTooltip">Add a line to enter data</span> <!-- Added ID -->
    </button>
    <button class="button2" id="deleteLineButton" onclick="delete_lignes()">Delete line
        <span class="tooltip" id="deleteLineTooltip">Delete a line from enter data</span> <!-- Added ID -->
    </button>
    <button class="button2" id="saveHypothesisButton" onclick="add_virtual_profile()">Save hypothesis
        <span class="tooltip" id="saveHypothesisTooltip">Add virtual patients to your profile</span> <!-- Added ID -->
    </button>
    <button class="button2" id="computeClosestButton" onclick="calculer_virtual_sort()">Compute closest
        <span class="tooltip" id="computeClosestTooltip">Calculation based on entered data</span> <!-- Added ID -->
    </button>
    <script>
      // Variables globales pour les colonnes et les lignes
        let selectedCols = [];
        let rows = [];
        let profileName = '';
        let selectedRows = [];
        let data_transform = [];
        let currentUserUid  = null; // Stores the current user
        let virtualProfiles = {}; // Object to store saved profile
        let virtualProfilesData ={};
        let currentPageLanguage = 'en'; // Default
        const pageTranslations = {
            en: {
                pageTitle: "Virtual Patients Setup",
                loadingUserData: "Loading user data...",
                errorUserContext: "Error: User context not loaded. Please try reloading or logging in again.",
                errorNoData: "No data found for profile \"{profileName}\" for user {currentUserUid}. Please go back.",
                enterDataTitle: "Enter data for {profileName}",
                resultTitle: "Result virtual sort for ",
                enterValuePlaceholder: "Enter value",
                virtualProfileListLegend: "Saved Hypotheses (Virtual Profiles)",
                // Buttons & Tooltips
                addLineButton: "Add line",
                addLineTooltip: "Add a row to enter virtual patient data",
                deleteLineButton: "Delete line",
                deleteLineTooltip: "Delete the last added virtual patient row",
                saveHypothesisButton: "Save Hypothesis",
                saveHypothesisTooltip: "Save the entered virtual patient data as a hypothesis",
                computeClosestButton: "Compute Closest",
                computeClosestTooltip: "Calculate similarity based on entered virtual data and selected columns",
                // Prompts, Alerts, Confirms
                promptProfileName: "Please enter a hypothesis name:",
                alertValidName: "Please enter a valid name for the hypothesis.",
                confirmOverwriteProfile: "A hypothesis with this name already exists for this profile. Overwrite?",
                alertSelectColumn: "Please select at least one column for calculation!",
                alertRowNotValid: "Virtual patient row data is not valid (contains non-numeric or empty required values)!",
                alertSaveSuccess: "Hypothesis '{vProfileName}' saved successfully for profile '{profileName}'.",
                // Dynamic Table Content
                virtualStatus: "Virtual",
                realStatus: "Real",
                statusHeader: "Status" // Header for the Real/Virtual column in results
            },
            fr: {
                pageTitle: "Configuration Patients Virtuels",
                loadingUserData: "Chargement des données utilisateur...",
                errorUserContext: "Erreur : Contexte utilisateur non chargé. Veuillez recharger ou vous reconnecter.",
                errorNoData: "Aucune donnée trouvée pour le profil \"{profileName}\" pour l'utilisateur {currentUserUid}. Veuillez retourner en arrière.",
                enterDataTitle: "Entrer données pour {profileName}",
                resultTitle: "Résultat tri virtuel pour ",
                enterValuePlaceholder: "Entrer valeur",
                virtualProfileListLegend: "Hypothèses Sauvegardées (Profils Virtuels)",
                // Buttons & Tooltips
                addLineButton: "Ajouter ligne",
                addLineTooltip: "Ajouter une ligne pour entrer des données de patient virtuel",
                deleteLineButton: "Supprimer ligne",
                deleteLineTooltip: "Supprimer la dernière ligne de patient virtuel ajoutée",
                saveHypothesisButton: "Sauver Hypothèse",
                saveHypothesisTooltip: "Sauvegarder les données patient virtuel entrées comme hypothèse",
                computeClosestButton: "Calculer Proximité",
                computeClosestTooltip: "Calculer la similarité basée sur les données virtuelles et les colonnes sélectionnées",
                 // Prompts, Alerts, Confirms
                promptProfileName: "Veuillez entrer un nom pour l'hypothèse :",
                alertValidName: "Veuillez entrer un nom valide pour l'hypothèse.",
                confirmOverwriteProfile: "Une hypothèse avec ce nom existe déjà pour ce profil. Écraser ?",
                alertSelectColumn: "Veuillez sélectionner au moins une colonne pour le calcul !",
                alertRowNotValid: "Les données de la ligne patient virtuel ne sont pas valides (contient des valeurs non-numériques ou vides requises) !",
                alertSaveSuccess: "Hypothèse '{vProfileName}' sauvegardée avec succès pour le profil '{profileName}'.",
                 // Dynamic Table Content
                virtualStatus: "Virtuel",
                realStatus: "Réel",
                statusHeader: "Statut"
            }
        };

        function applyLanguage(lang) {
            if (!pageTranslations[lang]) lang = 'en';
            currentPageLanguage = lang;
            const T = pageTranslations[currentPageLanguage];

            document.documentElement.lang = lang;
            document.title = T.pageTitle;

            // Update static elements
            const legend = document.getElementById('virtualProfileListLegend');
            const addBtn = document.getElementById('addLineButton');
            const delBtn = document.getElementById('deleteLineButton');
            const saveBtn = document.getElementById('saveHypothesisButton');
            const computeBtn = document.getElementById('computeClosestButton');
            const addTooltip = document.getElementById('addLineTooltip');
            const delTooltip = document.getElementById('deleteLineTooltip');
            const saveTooltip = document.getElementById('saveHypothesisTooltip');
            const computeTooltip = document.getElementById('computeClosestTooltip');

            if (legend) legend.textContent = T.virtualProfileListLegend;

            if(addBtn) addBtn.childNodes[0].nodeValue = T.addLineButton + ' ';
            if(delBtn) delBtn.childNodes[0].nodeValue = T.deleteLineButton + ' ';
            if(saveBtn) saveBtn.childNodes[0].nodeValue = T.saveHypothesisButton + ' ';
            if(computeBtn) computeBtn.childNodes[0].nodeValue = T.computeClosestButton + ' ';

            if(addTooltip) addTooltip.textContent = T.addLineTooltip;
            if(delTooltip) delTooltip.textContent = T.deleteLineTooltip;
            if(saveTooltip) saveTooltip.textContent = T.saveHypothesisTooltip;
            if(computeTooltip) computeTooltip.textContent = T.computeClosestTooltip;

            // Update dynamically generated content if it exists
             const pageHeader = document.getElementById('pageTitleHeader');
             if(pageHeader && !document.getElementById('table').querySelector('table')) { // Only update if table not built yet
                  // Check if it's still the initial loading message
                  if (pageHeader.textContent === pageTranslations.en.loadingUserData || pageHeader.textContent === pageTranslations.fr.loadingUserData) {
                       pageHeader.textContent = T.loadingUserData;
                  } else {
                       // If data is loaded, re-render the relevant parts
                       if (currentUserUid && data_transform.length > 0) {
                            // Need to redraw the table header potentially, or at least the main title
                            const safeProfileName = profileName ? cleanProfileName(profileName) : '';
                            pageHeader.textContent = T.enterDataTitle.replace('{profileName}', safeProfileName);
                            // Re-call the function that builds the table might be necessary if placeholders need translation
                            enter_virtual_chiffre(); // Rebuild table with new placeholders/headers
                            display_virtual_profile(profileName); // Rebuild the list of saved profiles
                       } else if (currentUserUid) {
                           const safeProfileName = profileName ? cleanProfileName(profileName) : '';
                            pageHeader.textContent = T.errorNoData.replace('{profileName}', safeProfileName).replace('{currentUserUid}', currentUserUid);
                       } else {
                            pageHeader.textContent = T.errorUserContext;
                       }
                  }
             } else if (pageHeader && document.getElementById('table').querySelector('table')) {
                 // Table exists, just update the main title and potentially redraw table
                 const safeProfileName = profileName ? cleanProfileName(profileName) : '';
                 pageHeader.textContent = T.enterDataTitle.replace('{profileName}', safeProfileName);
                 enter_virtual_chiffre(); // Rebuild table with new placeholders/headers
                 display_virtual_profile(profileName); // Rebuild list
             }


            console.log(`Virtual page language applied: ${lang}`);
        }

            function getUserStorageKey(baseKey) {
                if (!currentUserUid) {
                    return null;
                }
                return `${currentUserUid}_${baseKey}`;
            }

            function setUserItem(baseKey, value) {
                const userKey = getUserStorageKey(baseKey);
                if (userKey) {
                    try {
                        localStorage.setItem(userKey, JSON.stringify(value));
                        console.log(`Saved to localStorage [${userKey}]`);
                    } catch (e) {
                        console.error(`Error saving to localStorage [${userKey}]:`, e);
                        alert("Error saving data. Storage might be full.");
                    }
                }
            }

            function getUserItem(baseKey, defaultValue = null) {
                    const userKey = getUserStorageKey(baseKey);
                if (!userKey) return defaultValue;
                try {
                    const item = localStorage.getItem(userKey);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.error(`Error parsing user item ${userKey}:`, e);
                    return defaultValue;
                }
            }

            // --- End Helper Functions ---

            // Function to initialize the page after user context is known
            function initializePageVirtual() {
                const T = pageTranslations[currentPageLanguage];
                const pageHeader = document.getElementById('pageTitleHeader');
                currentUserUid = getUserItem('currentUserUid', null); // Load UID if previously stored by pagehome
                if (!currentUserUid) {
                    console.error("Cannot initialize page: Username not set.");
                    if (pageHeader) pageHeader.textContent = T.errorUserContext; // Use translated error
                    return;
                }
                console.log(`Initializing result page for user: ${currentUserUid}`);
                selectedCols = getUserItem('selectedCols',[]);
                rows = getUserItem('rows',[]);
                profileName = getUserItem('profileName','');
                selectedRows = getUserItem('selectedRows',[]);
                data_transform = getUserItem('data_transform',[]);

                virtualProfiles = getUserItem('virtualProfiles', {});       // Load the saved profiles list/data
                virtualProfilesData = getUserItem('virtualProfilesData', {}); // Load the associated metadata
                console.log("Loaded virtual profiles:", virtualProfiles);
                console.log("Loaded virtual profiles data:", virtualProfilesData);
                applyLanguage(currentPageLanguage); // This will set the main title correctly

                // Check if the HTML content string exists and is not empty
                if (!data_transform || data_transform.length === 0) {
                     console.warn("No original data_transform found.");
                     const safeProfileName = profileName ? cleanProfileName(profileName) : '';
                     if (pageHeader) pageHeader.textContent = T.errorNoData.replace('{profileName}', safeProfileName).replace('{currentUserUid}', currentUserUid);
                     // Disable buttons?
                    return;
                }

                // Now display the table with the loaded HTML content
                enter_virtual_chiffre();
                display_virtual_profile(profileName);
            }

        window.addEventListener('message', (event) => {
            if (event.data && event.data.action) {
                console.log(`similarity.html received message:`, event.data);
                switch(event.data.action) {
                    case 'setUser':
                        const receivedUid = event.data.uid;
                        console.log(`User context received: UID=${receivedUid}`);
                        if (!currentUserUid || currentUserUid !== receivedUid) {
                            currentUserUid = receivedUid;
                            setUserItem('currentUserUid', currentUserUid);
                            console.log(`User UID set to: ${currentUserUid}. Initializing page...`);
                            initializePageVirtual();
                        } else {
                             console.log(`User ${currentUserUid} already set. Re-initializing (data might have changed in pagehome).`);
                             initializePageVirtual();
                        }
                        break;
                    case 'setLanguage':
                        console.log(`Language received: ${event.data.lang}`);
                        applyLanguage(event.data.lang);
                        break;
                     default:
                         console.log("Received unhandled message action:", event.data.action);
                         break;
                }
            }
        });
            function cleanProfileName(name) {
                // Replace unwanted characters " and \ with an empty string
                return name.replace(/["\\]/g, '');
            }
            console.log(profileName);

        function enter_virtual_chiffre() {
            const T = pageTranslations[currentPageLanguage];
            const safeProfileName = profileName ? cleanProfileName(profileName) : '';
            const tableContainer = document.getElementById('table');
            const pageHeader = document.getElementById('pageTitleHeader');
            if(pageHeader) pageHeader.textContent = T.enterDataTitle.replace('{profileName}', safeProfileName);
            if (!data_transform || data_transform.length === 0 || !tableContainer) {
                console.error("Cannot build table: Original data or container missing.");
                if (tableContainer) tableContainer.innerHTML = `<p>${T.errorNoData.replace('{profileName}', safeProfileName).replace('{currentUserUid}', currentUserUid)}</p>`;
                return;
            }
            let table = `<table><thead><tr>`;
            // Create column headers
            selectedCols.forEach(colIndex => {
                table += `<th><input type='checkbox' class='columnSelect' value='${colIndex}'>${data_transform[0][colIndex]}</th>`;
            });
            table += "</tr></thead><tbody>";

            // Add rows with input fields
            selectedRows.forEach((rowIndex) => {
                table += "<tr>";
                selectedCols.forEach((colIndex) => {
                    table += `<td><input type="text" placeholder="${T.enterValuePlaceholder}" value="${data_transform[rowIndex][colIndex]}" ></td>`;
                });
                table += "</tr>";
            });
            table += "</tbody></table>";

            // Inject the table into the DOM
            tableContainer.innerHTML = table;
        }

        function add_lignes() {
            // Récupérer le tableau existant
            const T = pageTranslations[currentPageLanguage];
            const tableBody = document.querySelector('#table table tbody');

            // Vérifier si le tableau body existe
            if (tableBody) {
                // Ajouter une nouvelle ligne
                const newRow = tableBody.insertRow();

                // Ajouter des cellules avec champs d'entrée dans la nouvelle ligne
                selectedCols.forEach(() => {
                    const newCell = newRow.insertCell();
                    newCell.innerHTML = `<input type="text" placeholder="${T.enterValuePlaceholder}">`;
                });
            }
        }


         function delete_lignes() {
             const tableBody = document.querySelector('#table table tbody');
             // Prevent deleting the initial rows derived from selection
             const initialRowCount = selectedRows.length;
             if (tableBody && tableBody.rows.length > initialRowCount) {
                 tableBody.deleteRow(tableBody.rows.length - 1);
             } else if (tableBody && tableBody.rows.length > 0 && initialRowCount === 0) {
                  // Allow deleting if no rows were initially selected
                  tableBody.deleteRow(tableBody.rows.length - 1);
             }
         }

    function add_virtual_profile() {
        const T = pageTranslations[currentPageLanguage];
        const tableBody = document.querySelector('#table table tbody');
        const formattedVirtualRows = [];
        const virtualprofileName = prompt(T.promptProfileName);

        // Validation du nom de profil
        if (!virtualprofileName || virtualprofileName.trim() === "") {
            alert(T.alertValidName);
            return;
        }

        // Vérification des doublons
        if (virtualProfiles[profileName] && virtualProfiles[profileName][virtualprofileName]) {
            if (!confirm(T.confirmOverwriteProfile)) {
                return;
            }
        }
        // Vérifier et initialiser les objets avant d'accéder aux propriétés
        if (!virtualProfilesData[profileName]) {
            virtualProfilesData[profileName] = {};
        }

        if (!virtualProfilesData[profileName][virtualprofileName]) {
            virtualProfilesData[profileName][virtualprofileName] = {
                data: [],
                cols: [],
                rows: [],
                fullrow:[]
            };
        }
        virtualProfilesData[profileName][virtualprofileName]["data"] = JSON.parse(JSON.stringify(data_transform));
        virtualProfilesData[profileName][virtualprofileName]["cols"] = JSON.parse(JSON.stringify(selectedCols));
        virtualProfilesData[profileName][virtualprofileName]["rows"] = JSON.parse(JSON.stringify(selectedRows));
        virtualProfilesData[profileName][virtualprofileName]["fullrow"] = JSON.parse(JSON.stringify(rows));

        let header_virtual = [];
        selectedCols.forEach(colIndex => {
            header_virtual.push(data_transform[0][colIndex]);
        });
        formattedVirtualRows.push(header_virtual);

        if (tableBody) {
            Array.from(tableBody.rows).forEach(row => {
                const rowData = Array.from(row.cells).map(cell => {
                    const input = cell.querySelector("input");
                    return input ? input.value : null; // Récupérer la valeur entrée ou null par défaut
                });
                formattedVirtualRows.push(rowData);
            });
        }

        virtualProfiles[profileName] = virtualProfiles[profileName] || {};
        virtualProfiles[profileName][virtualprofileName] = formattedVirtualRows;

        setUserItem('virtualProfiles',virtualProfiles);
        setUserItem('virtualProfilesData',virtualProfilesData);

        if (profileName) {
            display_virtual_profile(profileName);
        } else {
            console.warn("profileName is not defined.");
        }

    }

    function display_virtual_profile(profileName){
        const virtualListContainer = document.getElementById("virtualListContainer");
            if (!profileName || profileName === "(Aucun)") {
                return;
            }
            if (!virtualListContainer) {
                console.error("Container for profile list ('virtualListContainer') not found!");
                return;
            }
            // Nettoyer le conteneur pour éviter les doublons
            virtualListContainer.innerHTML = "";
            if (!virtualProfiles[profileName]) {
                virtualProfiles[profileName] = {}; // Initialiser l'objet s'il est vide
            }
            // Ajouter un bouton pour chaque profil dans `savedProfiles`
            Object.keys(virtualProfiles[profileName]).forEach((childProfile) => {
                    const virtualprofileButton = document.createElement("button");
                    virtualprofileButton.textContent = childProfile;
                    virtualprofileButton.style.cssText = `
                        width: 100%;
                        padding: 10px;
                        margin: 5px 0;
                        color: white;
                        background-color: #007bff;
                        border: none;
                        border-radius: 30px;
                        font-size: 16px;
                        cursor: pointer;
                        transition: all 0.3s ease-in-out;
                        text-align: center;
                    `;

                    // Ajouter un événement 'click'
                virtualprofileButton.onclick = () => {
                    // Réinitialiser la couleur de tous les boutons
                    Array.from(virtualListContainer.children).forEach((btn) => {
                        btn.style.backgroundColor = "#007bff"; // Couleur par défaut
                    });

                    // Changer la couleur du bouton cliqué
                    virtualprofileButton.style.backgroundColor = "#28a745"; // Couleur par exemple 'vert'
                    display_virtualprofile_content(childProfile);
                };

                    // Ajouter le bouton au conteneur
                    virtualListContainer.appendChild(virtualprofileButton);
            });
    }
    function display_virtualprofile_content(virtualprofileName) {
        const T = pageTranslations[currentPageLanguage];

        if (!profileName || !virtualprofileName) {
            return;
        }

        if (!virtualProfilesData[profileName] || !virtualProfilesData[profileName][virtualprofileName]) {
            console.error(`Virtual profile data not found: ${profileName} -> ${virtualprofileName}`);
            return;
        }

        // Charger les données du profil virtuel sélectionné
        let content = virtualProfiles[profileName][virtualprofileName];
        data_transform = JSON.parse(JSON.stringify(virtualProfilesData[profileName][virtualprofileName]["data"])) || [];
        selectedCols = JSON.parse(JSON.stringify(virtualProfilesData[profileName][virtualprofileName]["cols"])) || [];
        selectedRows = JSON.parse(JSON.stringify(virtualProfilesData[profileName][virtualprofileName]["rows"])) || [];
        rows = JSON.parse(JSON.stringify(virtualProfilesData[profileName][virtualprofileName]["fullrow"])) || [];


        // Mettre à jour le tableau avec les nouvelles données
        let table = `<table><thead><tr>`;
        // Create column headers
        selectedCols.forEach(colIndex => {
            table += `<th><input type='checkbox' class='columnSelect' value='${colIndex}'>${data_transform[0][colIndex]}</th>`;
        });
        table += "</tr></thead><tbody>";

        // Ajouter les lignes avec les données enregistrées
        content.slice(1).forEach(rowData => {
            table += "<tr>";
            rowData.forEach(cellData => {
                table += `<td><input type="text" placeholder="${T.enterValuePlaceholder}" value="${cellData}"></td>`;
            });
            table += "</tr>";
        });

        table += "</tbody></table>";

        // Injecter le tableau dans le DOM
        document.getElementById('table').innerHTML = table;
    }
console.log(virtualProfiles);
console.log(virtualProfilesData);
    function euclideanDistance(vec1, vec2) {
        if (!vec1 || !vec2 || vec1.length !== vec2.length) {
           throw new Error('Vectors are undefined or of different lengths');
       }
        let sum = 0;
        for (let i = 0; i < vec1.length; i++) {
            sum += Math.pow(vec1[i] - vec2[i], 2);
        }
        return Math.sqrt(sum);
    }

    function trierParDistanceEuclidienne(fullRows, virtual_Rows, filteredRows) {
        let lines = [];

        // Diviser les lignes choisi avec des autres lignes
        for (let i = 0; i < filteredRows.length; i++) {
            lines.push({ original: fullRows[i], filtered: filteredRows[i] });
        }
        console.log(lines);

        let distanceMin = [];
        // Calculer par le euclidean algorithme
        for (let i = 0; i < lines.length; i++) {
            let distances = [];
            for (let j = 0; j < virtual_Rows.length; j++) {
                let dist = euclideanDistance(lines[i].filtered, virtual_Rows[j]);
                distances.push(dist);
            }
            let minDist = Math.min(...distances);
            distanceMin.push({ row: lines[i].original, distance_min: minDist });
        }

        // Sort par le distance
        distanceMin.sort((a, b) => a.distance_min - b.distance_min);
        console.log(distanceMin);
        // Return un nouveau table après similarité
        return distanceMin.map(item => item.row);
    }


    function calculer_virtual_sort() {
        const T = pageTranslations[currentPageLanguage];
        console.log("Data calcul: ",data_transform);
        console.log("Selected Cols calcul: ", selectedCols);
        console.log("Selected Rows calcul: ", selectedRows);
        console.log("FullRows calcul: ", rows);
        // Récupérer toutes les lignes ajoutées dynamiquement par l'utilisateur
        const tableBody = document.querySelector('#table table tbody');
        const selectedColums = Array.from(document.querySelectorAll('input.columnSelect:checked')).map(input => parseInt(input.value));
        if(selectedColums.length === 0){
            alert("Please select at least one column!");
            return;
        }
        console.log("Columm calacul: ",selectedColums);
        const virtual_Rows_final = [];
        let headers_virtual = [];
        const formattedVirtualRows = [];
        selectedColums.forEach((colIndex) => {
            headers_virtual.push(data_transform[0][colIndex]);
        });
        virtual_Rows_final.push(headers_virtual);

        if (tableBody) {
            Array.from(tableBody.rows).forEach(row => {
                const rowData = Array.from(row.cells).map(cell => {
                    const input = cell.querySelector("input");
                    return input ? parseFloat(input.value) || 0 : 0; // Récupérer la valeur entrée ou 0 par défaut
                });
                let header_virtual = [];
                selectedCols.forEach(colIndex => {
                    header_virtual.push(data_transform[0][colIndex]);
                });

                const rowDatafull = [];
                rowDatafull.push(header_virtual);
                rowDatafull.push(rowData);
                const data_calcul = [];
                virtual_Rows_final[0].forEach(header => {
                    for (let i = 0; i < rowDatafull[0].length; i++) {
                        if(rowDatafull[0][i].trim() === header){
                            data_calcul.push(rowDatafull[1][i]);
                        }
                    }
                });
                virtual_Rows_final.push(data_calcul);
            });
        }
        if (tableBody) {
            Array.from(tableBody.rows).forEach(row => {
                const rowData = Array.from(row.cells).map(cell => {
                    const input = cell.querySelector("input");
                    return input ? input.value: null; // Récupérer la valeur entrée ou 0 par défaut
                });
                formattedVirtualRows.push(rowData);
            });
        }
        console.log("Virtual rows: ",formattedVirtualRows);
        console.log(virtual_Rows_final);
        const virtual_Rows = virtual_Rows_final.slice(1);

        // Vérifier si des lignes ont été sélectionnées / remplies
        if (virtual_Rows.length === 0 || virtual_Rows.some(row => row.every(value => value === 0))) {
            alert(T.alertRowNotValid);
            return;
        }

        // Des valeurs pour les colonnes on a chosi
        const filteredRows = data_transform.slice(1).map(row => {
            return selectedColums.map(colIndex => parseFloat(row[colIndex]) || 0);
        });

        // Valeur original dans ce fichier
        const fullRows = data_transform.slice(1).map(row => {
            return selectedCols.map(colIndex => parseFloat(row[colIndex]) || 0);
        });
        console.log("Full:",fullRows);
        console.log("Fil: ",filteredRows);
        console.log("Virtual: ",virtual_Rows);
        // Données après similarité

        const orderedData = trierParDistanceEuclidienne(fullRows, virtual_Rows, filteredRows);
        console.log(orderedData);

        console.log("Rows:",rows);
        console.log("virtual_Rows: ",virtual_Rows_final);

        // Ajouter "Real" à la fin de chaque ligne du orderedData
        let formattedVirtualRows1 = formattedVirtualRows.map(row => {
            let newRow = [...row]; // Faire une copie de la ligne
            newRow.push(T.virtualStatus); // Ajouter "Real" comme dernier élément de la ligne
            return newRow;
        });

        // Ajouter "Real" à la fin de chaque ligne du orderedData
        let formattedOrderedData = orderedData.map(row1 => {
            let newRow = [...row1]; // Faire une copie de la ligne
            newRow.push(T.realStatus); // Ajouter "Real" comme dernier élément de la ligne
            return newRow;
        });

        // Insérer les virtual_Rows au début de orderedData
        let fullData = [...formattedVirtualRows1, ...formattedOrderedData];
        console.log(fullData);
        // Creer un table pour des nouveau fichier .csv après similarité
        let table = `<div class=\"table\" id=\"table\"> <h1>${T.resultTitle} ${profileName}</h1><table><thead><tr>`;
        rows[0].forEach(header => {
            table += `<th>${header}</th>`;
        });
        table += `<th>Status</th>`
        table += "</tr></thead><tbody>";

        fullData.forEach(rowData => {
            // Check the last element to determine the type
            const rowType = rowData[rowData.length - 1];
            let rowClass = ""; // Default: no extra class

            if (rowType === T.virtualStatus) {
                rowClass = " class='virtual-row'"; // Note the space before 'class'
            }

            table += `<tr${rowClass}>`;

            for (let i = 0; i < rowData.length; i++) {
                const cellData = rowData[i];
                table += `<td>${cellData}</td>`; // Add the table data cell
            }
                table += "</tr>"; // Close the table row
});
        table += "</tbody></table></div>";
        setUserItem('table',table);
        setUserItem('profileName',profileName);
        setUserItem('fullData',fullData);

        console.log("Requesting parent to load result_virtual.html");
        window.parent.postMessage({
            action: 'requestNavigation',
            targetPage: 'result_virtual.html',
            targetId: 'result_virtual' // The ID of the link in index.html's nav
        }, '*');

    }
    if (!currentUserUid) {
        const initialLang = localStorage.getItem('appLanguage') || 'en';
        const initialT = pageTranslations[initialLang];
        const pageHeader = document.getElementById('pageTitleHeader');
        if (pageHeader) pageHeader.textContent = initialT.loadingUserData;
        applyLanguage(initialLang); // Try applying language early
    }

    </script>
</body>
</html>